# Предложения по структуре таблиц Clickhouse

В большинстве случаев при обработке больших объемов потоковых (TimeSeries) потоков данных
мы имеем дело с одной большой потоковой таблицей к которой необходимо производить поисковые или аггрегаионные
аналитические запросы. 
Часто для этих запросов необходимо производить операции соединения (JOIN) со справочными таблицами для включения в запрос 
полей справочных таблиц для поиска по ним или аггрегации.

Данные операции довольно затратны как по времени выполнения, так и по оперативной памяти.

Так как столбцовые базы данных показывают отличную производительность на "широких" таблицах
предлагается создать "широкую" деномализованную таблицу в которую включить как 
основную потоковую информацию так и поля из справочных таблиц по которым производятся поисковые и аггрегационные запросы.

В этом случае основные запросы будет производиться без операции JOIN.

На основе данной "широкой" деномализованной таблицы для доступа к разного типа информации (информации от разного типа источников со своим набором полей) можно создать необходимое число представлений (View) к которым и производить  обращение из приложений.



## Широкая Большая таблица

Рассмотрим пример большой денормализованной таблицы `grzevents_BigTable`:

grzevents_BigTable | odisseyevents | ФотофиксацияТС  
-------------------|-----------------|----------------
primarykey | ✗ | primarykey
createtime | ✗ | createtime
creator | typeid | creator
edittime | ✗ | edittime
editor | ✗ | editor
НомерТС | grz | НомерТС
Скорость | speed | Скорость
ОграничениеСкорости | ✗ |  ОграничениеСкорости
ИдентификаторМатериала | ✗ |  ИдентификаторМатериала
Время | datetime | Время
ДатаПоступления| ✗ |  ДатаПоступления
Получатель| ✗ |  Получатель
photo_id } photo_id | ✗
**Источник** | ✗ |  Источник
**Оборудование** | ✗ | ✗
**КомплексОборудования** | ✗ | ✗
*КомплексОборудования_Идентификатор* | object_id |  ✗ 
*Оборудование_Идентификатор* | camera_direction_id |  ✗
*Источник_Идентификатор* | camera_id |  ✗

Информация размещенная в данной таблице доступна в виде двух представлений:
- odisseyevents - представления для системы Сокол-аналитика;
- ФотофиксацияТС - представления для системы Сокол.

Поля выделенные курсивом - деномализованные значения полей соответсвующих таблиц (Источник, Оборудования, КомплексОборудования).
(Если в исходной потоковом сообщении основными полями являются поля object_id, camera_direction_id, camera_id денормализованными будут поля выделенные жирным шрифтом).

Формирование значений основных и соответствующих деномализованных полей обеспечивает адартер обрабабывающий поток данных.

Клиентское приложение может работать с таблицей grzevents_BigTable как напрямую, так и через представления:
```
CREATE VIEW odisseyevents (
  creator AS typeid,
  "НомерТС" AS grz,
  "Скорость" AS speed,
  "Время" AS datetime,
  photo_id AS  photo_id,
  "КомплексОборудования_Идентификатор" AS object_id,
  "Оборудование_Идентификатор" AS camera_direction_id,
  "Источник_Идентификатор" AS camera_id
  )
FROM   grzevents_BigTable
```

```
CREATE VIEW "ФотофиксацияТС" (
  primarykey,
  createtime,
  creator,
  edittime,
  editor,
  ОграничениеСкорости,
  НомерТС,
  Скорость,
  ОграничениеСкорости,
  Время,
  ДатаПоступления,
  Получатель,
  Источник
)
FROM   grzevents_BigTable
```

Сервис данных (`DataService`) "зная" структуру денормализованной таблицы должен избегать использование "излишних" соединений.
Например, при запросе значения поля `Идентификатор` справочника Источник `DataService`
не должен производить соединение (`JOIN`) таблиц  `grzevents_BigTable` и Источник 
с последующим выбором значение поля `Источник.Идентификатор`,
а использовать значение поля `Источник_Идентификатор`.


## Импортирование таблиц Postgres как словарей Clickhouse

В состав полей большой деномализованной таблицы не следует включать "справочные" поля - 
строки наименований объектов и т.п.

В этом случае используются справочные таблицы импортированные из базы данных Postgres.
В рамках docker-репозитория `Flexberry` создан образ [flexberry/clickhouse-official](https://hub.docker.com/r/flexberry/clickhouse-official)
[поддерживающий данный функционал](https://github.com/Flexberry/dockerfiles/blob/master/clickhouse/official/README-ru.md).
